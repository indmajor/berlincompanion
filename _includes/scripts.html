<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
crossorigin=""></script>

<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.67.0/dist/L.Control.Locate.min.js" charset="utf-8"></script>

<script src="{{ "assets/js/lightgallery/lightgallery.min.js" | relative_url }}"></script>
<script src="{{ "assets/js/lightgallery/lg-thumbnail.min.js" | relative_url }}"></script>
<!-- <script src="{{ "assets/js/lightgallery/lg-fullscreen.min.js" | relative_url }}"></script> -->

<script>

var lat = 52.5200;
var lng = 13.4050;
var zoom = 11;

{% if page.lat and page.lng %}
lat = {{ page.lat }};
lng = {{ page.lng }};
zoom = 17;
{% endif %}

var map = L.map('berlin-map').setView([lat, lng], zoom);

L.control.locate({
  returnToPrevBounds: true
}).addTo(map);

L.tileLayer('https://a.tile.openstreetmap.org/{z}/{x}/{y}.png ', {
  maxZoom: 18,
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

map.on('popupopen', function(e) {
  var px = map.project(e.target._popup._latlng); // find the pixel location on the map where the popup anchor is
  px.y -= e.target._popup._container.clientHeight/2; // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
  map.panTo(map.unproject(px),{animate: true}); // pan to new center
});

{% if page.tag %}
  {% for post in site.tags[page.tag] %}
    var marker = L.marker([{{ post.lat}}, {{ post.lng }}]).addTo(map);
    marker
    .bindPopup(
      '<a href="{{ post.url | relative_url }}"><img src={{ post.images[0] | append: ".thumbnail.jpg" | relative_url }}>{{ post.title | escape }}</a>',
      {
        maxWidth: 140,
        maxHeight: 170
      }
    );
    {% if post.url == page.url %}
    marker.bindPopup('{{ post.title | escape }}', {'closeButton': false}).openPopup();
    {% endif %}
  {% endfor %}
{% else %}
  {% for post in site.posts %}
    var marker = L.marker([{{ post.lat}}, {{ post.lng }}]).addTo(map);
    marker
    .bindPopup(
      '<a href="{{ post.url | relative_url }}"><img src={{ post.images[0] | append: ".thumbnail.jpg" | relative_url }}>{{ post.title | escape }}</a>',
      {
        maxWidth: 140,
        maxHeight: 170
      }
    );
    {% if post.url == page.url %}
    marker.bindPopup('{{ post.title | escape }}', {'closeButton': false}).openPopup();
    {% endif %}

  {% endfor %}
{% endif %}


</script>

<script type="text/javascript">
lightGallery(document.getElementById('lightgallery'), {
  thumbnail: true,
  showThumbByDefault: false
});
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
